---
import DefaultLayout from '@layouts/DefaultLayout.astro'
import PageHeader from '@components/PageHeader.astro'
---

<DefaultLayout title="Password Lab">
  <PageHeader
      title="Password Lab"
      subtitle="Mix letters, numbers, and symbols to build a super-strong password. The longer and more mixed, the better!"
      bgType="bordered"
  />

<section class="my-12">
    <div class="container mb-12">
      <div class="mb-10 flex flex-col gap-6">
        <h2 class="mb-2">How It Works</h2>
        <p>
          Choose your password ingredients, then hit Generate. Try making three passwords and
          pick the strongest one.
        </p>
        <p class="rounded-lg border border-amber-200 bg-amber-50 p-4 text-sm text-amber-900">
          Safety note: Never use real names, birthdays, or school info in passwords.
        </p>
      </div>

      <div class="grid grid-cols-1 items-start gap-12 lg:grid-cols-2">
        <div class="rounded-xl border border-slate-200 bg-white p-6 shadow-sm">
          <h3 class="mb-4 text-base font-semibold">Recipe Builder</h3>

          <label class="text-sm font-semibold" for="pw-length">Password length</label>
          <div class="mt-3 flex items-center gap-4">
            <input
              id="pw-length"
              type="range"
              min="8"
              max="20"
              value="12"
              class="h-2 w-full cursor-pointer accent-indigo-600"
            />
            <span id="pw-length-value" class="min-w-[2.5rem] rounded-md bg-slate-100 px-2 py-1 text-center text-sm font-semibold">
              12
            </span>
          </div>

          <div class="mt-6 grid grid-cols-1 gap-3">
            <label class="flex items-center gap-3 rounded-lg border border-slate-200 px-3 py-2 text-sm">
              <input id="opt-lower" type="checkbox" class="h-4 w-4" checked data-option />
              Lowercase letters (a b c)
            </label>
            <label class="flex items-center gap-3 rounded-lg border border-slate-200 px-3 py-2 text-sm">
              <input id="opt-upper" type="checkbox" class="h-4 w-4" checked data-option />
              Uppercase letters (A B C)
            </label>
            <label class="flex items-center gap-3 rounded-lg border border-slate-200 px-3 py-2 text-sm">
              <input id="opt-number" type="checkbox" class="h-4 w-4" checked data-option />
              Numbers (1 2 3)
            </label>
            <label class="flex items-center gap-3 rounded-lg border border-slate-200 px-3 py-2 text-sm">
              <input id="opt-symbol" type="checkbox" class="h-4 w-4" checked data-option />
              Symbols (! ? # *)
            </label>
          </div>

          <button
            id="generate-password"
            class="mt-6 w-full rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-700"
          >
            Generate
          </button>
          <p id="option-warning" class="mt-3 hidden text-xs font-semibold text-rose-600">
            Pick at least one ingredient to generate a password.
          </p>
        </div>

        <div class="rounded-xl border border-slate-200 bg-white p-6 shadow-sm">
          <div class="mb-4 flex items-center justify-between">
            <h3 class="text-base font-semibold">Your Password</h3>
            <span class="rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-600">
              Practice Only
            </span>
          </div>

          <div class="password-display" id="password-display" aria-live="polite">
            Click Generate to make a password
          </div>

          <div class="mt-4 flex flex-wrap gap-3">
            <button id="copy-password" class="rounded-md border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50">
              Copy
            </button>
            <button id="shuffle-password" class="rounded-md border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50">
              Regenerate
            </button>
          </div>

          <div class="mt-6">
            <div class="strength-meter" aria-hidden="true">
              <div id="strength-bar" class="strength-bar"></div>
            </div>
            <p id="strength-label" class="mt-2 text-sm font-semibold text-slate-700">Strength: ?</p>
          </div>

          <div class="mt-6 rounded-lg border border-slate-100 bg-slate-50 p-4 text-xs text-slate-600">
            Challenge: Make 3 passwords, then circle the one that is longest and most mixed.
          </div>
        </div>
      </div>
    </div>
</section>

<style>
  .password-display {
    border-radius: 0.75rem;
    border: 2px dashed #cbd5e1;
    background: #f8fafc;
    padding: 1rem;
    font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
    font-size: 1rem;
    letter-spacing: 0.08em;
    color: #1e293b;
    min-height: 3.5rem;
    display: flex;
    align-items: center;
  }
  .strength-meter {
    width: 100%;
    height: 0.6rem;
    background: #e2e8f0;
    border-radius: 9999px;
    overflow: hidden;
  }
  .strength-bar {
    height: 100%;
    width: 0%;
    background: #38bdf8;
    transition: width 0.2s ease, background 0.2s ease;
  }
</style>

<script>
  const lengthInput = document.getElementById('pw-length')
  const lengthValue = document.getElementById('pw-length-value')
  const display = document.getElementById('password-display')
  const warning = document.getElementById('option-warning')
  const generateButton = document.getElementById('generate-password')
  const shuffleButton = document.getElementById('shuffle-password')
  const copyButton = document.getElementById('copy-password')
  const strengthBar = document.getElementById('strength-bar')
  const strengthLabel = document.getElementById('strength-label')

  const options = {
    lower: document.getElementById('opt-lower'),
    upper: document.getElementById('opt-upper'),
    number: document.getElementById('opt-number'),
    symbol: document.getElementById('opt-symbol')
  }

  const sets = {
    lower: 'abcdefghijkmnopqrstuvwxyz',
    upper: 'ABCDEFGHJKLMNPQRSTUVWXYZ',
    number: '23456789',
    symbol: '!?#*@$'
  }

  const randomIndex = (max) => {
    const array = new Uint32Array(1)
    window.crypto.getRandomValues(array)
    return array[0] % max
  }

  const shuffle = (array) => {
    for (let i = array.length - 1; i > 0; i -= 1) {
      const j = randomIndex(i + 1)
      const temp = array[i]
      array[i] = array[j]
      array[j] = temp
    }
    return array
  }

  const buildPassword = () => {
    const length = Number(lengthInput.value)
    const selected = Object.entries(options).filter(([, input]) => input.checked)
    if (selected.length === 0) {
      warning.classList.remove('hidden')
      return ''
    }
    warning.classList.add('hidden')

    const pool = selected.map(([key]) => sets[key]).join('')
    const passwordChars = []

    selected.forEach(([key]) => {
      const set = sets[key]
      passwordChars.push(set[randomIndex(set.length)])
    })

    while (passwordChars.length < length) {
      passwordChars.push(pool[randomIndex(pool.length)])
    }

    return shuffle(passwordChars).join('')
  }

  const updateStrength = (password) => {
    if (!password) {
      strengthBar.style.width = '0%'
      strengthBar.style.background = '#38bdf8'
      strengthLabel.textContent = 'Strength: Ready to build'
      return
    }

    let score = Math.min(password.length * 4, 60)
    let variety = 0
    if (options.lower.checked) variety += 1
    if (options.upper.checked) variety += 1
    if (options.number.checked) variety += 1
    if (options.symbol.checked) variety += 1
    score += variety * 10
    score = Math.min(score, 100)

    strengthBar.style.width = `${score}%`

    let label = 'Very Weak'
    let color = '#ff0000'
    if (score >= 80) {
      label = 'Strong'
      color = '#22c55e'
    } else if (score >= 55) {
      label = 'Getting stronger'
      color = '#f97316'
    }

    strengthBar.style.background = color
    strengthLabel.textContent = `Strength: ${label}`
  }

  const generateAndRender = () => {
    const password = buildPassword()
    if (!password) return
    display.textContent = password
    updateStrength(password)
  }

  if (lengthInput && lengthValue) {
    lengthInput.addEventListener('input', () => {
      lengthValue.textContent = lengthInput.value
    })
  }

  if (generateButton) {
    generateButton.addEventListener('click', generateAndRender)
  }

  if (shuffleButton) {
    shuffleButton.addEventListener('click', generateAndRender)
  }

  if (copyButton) {
    copyButton.addEventListener('click', async () => {
      const text = display.textContent.trim()
      if (!text || text.startsWith('Click Generate')) return
      try {
        await navigator.clipboard.writeText(text)
        copyButton.textContent = 'Copied!'
        setTimeout(() => {
          copyButton.textContent = 'Copy'
        }, 1200)
      } catch (error) {
        copyButton.textContent = 'Copy failed'
        setTimeout(() => {
          copyButton.textContent = 'Copy'
        }, 1200)
      }
    })
  }
</script>
</DefaultLayout>
