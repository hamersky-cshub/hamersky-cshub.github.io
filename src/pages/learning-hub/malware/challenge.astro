---
import DefaultLayout from '@layouts/DefaultLayout.astro'
import PageHeader from '@components/PageHeader.astro'
---

<DefaultLayout title="Human Antivirus Defender">
  <PageHeader
      title="Human Antivirus Defender"
      subtitle="You are the Cyber Scout. Read each clue and decide: is it malware or not?"
      bgType="bordered"
  />

<section class="my-12">
    <div class="container mb-12">
      <div class="mb-10 flex flex-col gap-6">
        <h2 class="mb-2">How It Works</h2>
        <p>
          Your job is to look for warning signs and make the right call. Pick the best choice for each card. 
        </p>
      </div>
      <div class="mission-rules" aria-label="Mission rules">
        <div class="rule-card">
          <h3>Look For</h3>
          <p>Unknown senders, surprise pop-ups, and requests for passwords.</p>
        </div>
        <div class="rule-card">
          <h3>Be Careful With</h3>
          <p>USB drives you find, "free" games, and links that feel rushed.</p>
        </div>
        <div class="rule-card">
          <h3>Safe Signs</h3>
          <p>Official school tools, clear permission reasons, and trusted stores.</p>
        </div>
      </div>
      <div class="mission-actions grid grid-cols-2">
        <button class="btn-primary" id="startMission">Start Mission</button>
        <button class="btn-ghost" id="shuffleMission">Shuffle Missions</button>
      </div>
    </div>
      
  </div>
  
  
<div class="container">
  <div class="game-shell" id="gameShell" hidden>
    <div class="game-top">
      <div class="score-block">
        <span class="score-label">Score</span>
        <span class="score-value" id="score">0</span>
      </div>
      <div class="progress-block">
        <span class="score-label">Progress</span>
        <div class="progress-track" role="progressbar" aria-valuenow="1" aria-valuemin="1" aria-valuemax="8">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <span class="progress-text" id="progressText">1 / 8</span>
      </div>
      <div class="score-block">
        <span class="score-label">Streak</span>
        <span class="score-value" id="streak">0</span>
      </div>
    </div>

    <div class="scenario-card" aria-live="polite">
      <div class="scenario-header">
        <p class="scenario-tag" id="scenarioTag">Scenario 1</p>
        <h3 id="scenarioTitle">Loading...</h3>
      </div>
      <p class="scenario-body" id="scenarioBody"></p>
      <div class="clue-list" id="clueList" aria-label="Clues"></div>

      <div class="decision-row" role="group" aria-label="Make your decision">
        <button class="btn-danger" id="btnMalware">This Is Malware</button>
        <button class="btn-safe" id="btnSafe">This Is Not Malware</button>
      </div>

      <div class="feedback" id="feedback" hidden>
        <div class="feedback-banner" id="feedbackBanner"></div>
        <p class="feedback-text" id="feedbackText"></p>
        <div class="feedback-actions">
          <button class="btn-primary" id="nextScenario">Next Mission</button>
        </div>
      </div>
    </div>

    <div class="tip-card" aria-live="polite">
      <h3>Tip</h3>
      <p id="tipText">Hover over each clue in your mind. If it feels pushy or sneaky, be careful.</p>
    </div>
  </div>

  <div class="game-finish" id="gameFinish" hidden>
    <h2>Mission Complete</h2>
    <p id="finalMessage"></p>
    <div class="badge-row">
      <div class="badge">
        <span class="badge-title">Shield Level</span>
        <span class="badge-value" id="shieldLevel">Bronze</span>
      </div>
      <div class="badge">
        <span class="badge-title">Total Score</span>
        <span class="badge-value" id="finalScore">0</span>
      </div>
      <div class="badge">
        <span class="badge-title">Best Streak</span>
        <span class="badge-value" id="bestStreak">0</span>
      </div>
    </div>
    <div class="mission-actions">
      <button class="btn-primary" id="playAgain">Play Again</button>
      <button class="btn-ghost" id="reviewTips">Review Tips</button>
    </div>
  </div>
</div>
</section>

<script type="module">
  const scenarios = [
    {
      title: "The Free Game Crate",
      body: "A website promises a free new game if you download a file named FreeGame.exe. It asks you to turn off antivirus first.",
      clues: ["Unknown website", "Executable .exe file", "Asks to disable antivirus"],
      isMalware: true,
      tip: "Real apps do not need you to turn off protection."
    },
    {
      title: "School Tablet Update",
      body: "Your teacher says there is a required update from the official school app store. It lists the school logo and version number.",
      clues: ["From a trusted store", "Teacher confirmed", "Clear version info"],
      isMalware: false,
      tip: "Updates from trusted school tools are usually safe."
    },
    {
      title: "Pop-Up Panic",
      body: "A pop-up says 'Your device is infected!' and tells you to call a phone number right now.",
      clues: ["Scare message", "Urgent call now", "Random phone number"],
      isMalware: true,
      tip: "Scareware uses fear to trick you. Close the pop-up."
    },
    {
      title: "Mystery USB",
      body: "You find a USB drive in the hallway labeled 'Homework Answers'.",
      clues: ["Found in public", "No owner", "Tempting label"],
      isMalware: true,
      tip: "Unknown USB drives can hide malware."
    },
    {
      title: "Video Call App",
      body: "A video call app asks for camera and microphone access so you can join class.",
      clues: ["Permission matches purpose", "Used for class", "No extra pop-ups"],
      isMalware: false,
      tip: "Apps may ask for permissions they truly need."
    },
    {
      title: "Secret Search Extension",
      body: "A browser add-on installs by itself and changes your search to a weird site you do not recognize.",
      clues: ["Installs without asking", "Changes settings", "Unfamiliar website"],
      isMalware: true,
      tip: "If it installs without permission, it is not safe."
    },
    {
      title: "Email from a Stranger",
      body: "An email from a person you do not know says 'Open this zip for math answers'.",
      clues: ["Unknown sender", "Zip attachment", "Too good to be true"],
      isMalware: true,
      tip: "Unknown attachments can be dangerous."
    },
    {
      title: "Library Learning App",
      body: "The school librarian recommends a reading app from the official app store with lots of reviews.",
      clues: ["Trusted recommendation", "Official app store", "Many reviews"],
      isMalware: false,
      tip: "Trusted sources and reviews can be good signs."
    }
  ];

  const startMission = document.getElementById('startMission');
  const shuffleMission = document.getElementById('shuffleMission');
  const gameShell = document.getElementById('gameShell');
  const gameFinish = document.getElementById('gameFinish');
  const scenarioTag = document.getElementById('scenarioTag');
  const scenarioTitle = document.getElementById('scenarioTitle');
  const scenarioBody = document.getElementById('scenarioBody');
  const clueList = document.getElementById('clueList');
  const btnMalware = document.getElementById('btnMalware');
  const btnSafe = document.getElementById('btnSafe');
  const feedback = document.getElementById('feedback');
  const feedbackBanner = document.getElementById('feedbackBanner');
  const feedbackText = document.getElementById('feedbackText');
  const nextScenario = document.getElementById('nextScenario');
  const retryScenario = document.getElementById('retryScenario');
  const scoreEl = document.getElementById('score');
  const streakEl = document.getElementById('streak');
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');
  const tipText = document.getElementById('tipText');
  const finalMessage = document.getElementById('finalMessage');
  const finalScore = document.getElementById('finalScore');
  const bestStreak = document.getElementById('bestStreak');
  const shieldLevel = document.getElementById('shieldLevel');
  const playAgain = document.getElementById('playAgain');
  const reviewTips = document.getElementById('reviewTips');

  let currentIndex = 0;
  let score = 0;
  let streak = 0;
  let best = 0;
  let shuffled = [...scenarios];

  const updateProgress = () => {
    const percent = ((currentIndex + 1) / shuffled.length) * 100;
    progressFill.style.width = `${percent}%`;
    progressText.textContent = `${currentIndex + 1} / ${shuffled.length}`;
    document.querySelector('.progress-track')?.setAttribute('aria-valuenow', String(currentIndex + 1));
  };

  const renderScenario = () => {
    const scenario = shuffled[currentIndex];
    scenarioTag.textContent = `Scenario ${currentIndex + 1}`;
    scenarioTitle.textContent = scenario.title;
    scenarioBody.textContent = scenario.body;
    tipText.textContent = scenario.tip;

    clueList.replaceChildren();
    const cluePrefix = document.createElement('span');
    cluePrefix.textContent = 'Clues:';
    clueList.appendChild(cluePrefix);
    scenario.clues.forEach((clue) => {
      const chip = document.createElement('div');
      chip.className = 'clue-chip';
      chip.textContent = clue;
      clueList.appendChild(chip);
    });

    feedback.hidden = true;
    btnMalware.disabled = false;
    btnSafe.disabled = false;

    updateProgress();
  };

  const showFeedback = (isCorrect, explanation) => {
    feedback.hidden = false;
    feedbackBanner.textContent = isCorrect ? 'Correct!' : 'Try Again!';
    feedbackBanner.className = isCorrect ? 'feedback-banner success' : 'feedback-banner warning';
    feedbackText.textContent = explanation;
  };

  const handleAnswer = (choice) => {
    const scenario = shuffled[currentIndex];
    const correct = scenario.isMalware === choice;
    if (correct) {
      score += 10;
      streak += 1;
      best = Math.max(best, streak);
      showFeedback(true, scenario.tip);
      btnMalware.disabled = true;
      btnSafe.disabled = true;
    } else {
      streak = 0;
      showFeedback(false, scenario.tip);
    }
    scoreEl.textContent = String(score);
    streakEl.textContent = String(streak);
  };

  const next = () => {
    if (currentIndex < shuffled.length - 1) {
      currentIndex += 1;
      renderScenario();
    } else {
      finishGame();
    }
  };

  const finishGame = () => {
    gameShell.hidden = true;
    gameFinish.hidden = false;
    finalScore.textContent = String(score);
    bestStreak.textContent = String(best);

    let level = 'Bronze';
    if (score >= 70) level = 'Gold';
    else if (score >= 50) level = 'Silver';
    shieldLevel.textContent = level;

    finalMessage.textContent = `You spotted ${score / 10} out of ${shuffled.length} correctly. Great job protecting the network!`;
  };

  const startGame = () => {
    score = 0;
    streak = 0;
    best = 0;
    currentIndex = 0;
    scoreEl.textContent = '0';
    streakEl.textContent = '0';
    gameFinish.hidden = true;
    gameShell.hidden = false;
    renderScenario();
  };

  const shuffleGame = () => {
    shuffled = [...scenarios].sort(() => Math.random() - 0.5);
    startGame();
  };

  startMission?.addEventListener('click', startGame);
  shuffleMission?.addEventListener('click', shuffleGame);
  btnMalware?.addEventListener('click', () => handleAnswer(true));
  btnSafe?.addEventListener('click', () => handleAnswer(false));
  nextScenario?.addEventListener('click', next);
  retryScenario?.addEventListener('click', renderScenario);
  playAgain?.addEventListener('click', startGame);
  reviewTips?.addEventListener('click', () => {
    gameFinish.hidden = true;
    gameShell.hidden = true;
    document.getElementById('startMission')?.scrollIntoView({ behavior: 'smooth' });
  });
</script>

<style>
  .mission-wrap {
    padding: 3rem 0 5rem;
    background: #ffffff;
    color: #111827;
  }

  .mission-hero {
    display: grid;
    gap: 2.5rem;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    align-items: center;
    padding: 0 1.5rem;
    max-width: 1200px;
    margin: 0 auto 3rem;
  }

  .mission-copy h2 {
    font-family: "Poppins", "Trebuchet MS", sans-serif;
    font-size: clamp(2rem, 3vw, 2.8rem);
    margin-bottom: 0.75rem;
  }

  .mission-copy p {
    font-size: 1.05rem;
    line-height: 1.6;
    color: #374151;
  }

  .mission-label {
    text-transform: uppercase;
    letter-spacing: 0.15em;
    font-size: 0.85rem;
    color: #2563eb;
    margin-bottom: 0.75rem;
  }

  .mission-actions {
    display: grid;
    gap: 1rem;
    margin: 2.5rem 0 2rem;
    align-items: center;
  }

  .btn-primary,
  .btn-ghost,
  .btn-danger,
  .btn-safe {
    border: none;
    border-radius: 10px;
    padding: 0.85rem 1.8rem;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .btn-primary {
    background: #2563eb;
    color: #ffffff;
    box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2);
  }

  .btn-ghost {
    background: #ffffff;
    color: #111827;
    border: 2px solid #e5e7eb;
  }

  .btn-danger {
    background: #ef4444;
    color: #ffffff;
    box-shadow: 0 10px 20px rgba(239, 68, 68, 0.2);
  }

  .btn-safe {
    background: #10b981;
    color: #ffffff;
    box-shadow: 0 10px 20px rgba(16, 185, 129, 0.2);
  }

  .btn-primary:hover,
  .btn-ghost:hover,
  .btn-danger:hover,
  .btn-safe:hover {
    transform: translateY(-2px);
  }

  .mission-rules {
    display: grid;
    gap: 1rem;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  }

  .rule-card {
    padding: 1rem 1.1rem;
    border-radius: 16px;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
  }

  .rule-card h3 {
    font-size: 1.05rem;
    margin-bottom: 0.4rem;
    color: #2563eb;
  }

  .mission-panel {
    background: #f8fafc;
    border-radius: 24px;
    padding: 2.5rem;
    border: 1px solid #e2e8f0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
  }

  .radar {
    width: 240px;
    height: 240px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(37, 99, 235, 0.15) 0%, rgba(241, 245, 249, 0.9) 70%);
    position: relative;
    overflow: hidden;
  }

  .radar-ring {
    position: absolute;
    inset: 15% 15%;
    border: 1px solid rgba(37, 99, 235, 0.2);
    border-radius: 50%;
  }

  .radar-ring:nth-child(2) {
    inset: 32% 32%;
  }

  .radar-ring:nth-child(3) {
    inset: 48% 48%;
  }

  .radar-sweep {
    position: absolute;
    inset: -50% 50% 50% -50%;
    background: linear-gradient(90deg, rgba(37, 99, 235, 0.45), transparent 70%);
    transform-origin: 100% 100%;
    animation: sweep 4s linear infinite;
  }

  .radar-dot {
    position: absolute;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #2563eb;
    box-shadow: 0 0 10px rgba(37, 99, 235, 0.35);
  }

  .dot-a { top: 35%; left: 60%; }
  .dot-b { top: 60%; left: 30%; }
  .dot-c { top: 50%; left: 70%; }

  .panel-caption {
    text-transform: uppercase;
    letter-spacing: 0.15em;
    font-size: 0.8rem;
    color: #2563eb;
  }

  .game-shell {
    max-width: 100%;
    margin: 0 auto;
    padding: 0 0;
  }

  .game-top {
    display: grid;
    gap: 1.5rem;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    margin-bottom: 2rem;
  }

  .score-block,
  .progress-block {
    background: #ffffff;
    border-radius: 18px;
    padding: 1rem 1.5rem;
    border: 1px solid #e5e7eb;
    box-shadow: 0 10px 20px rgba(15, 23, 42, 0.08);
  }

  .score-label {
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: #2563eb;
  }

  .score-value {
    display: block;
    font-size: 2rem;
    font-weight: 700;
    color: #111827;
  }

  .progress-track {
    height: 12px;
    border-radius: 999px;
    background: #e5e7eb;
    margin: 0.6rem 0;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #2563eb, #38bdf8);
    border-radius: 999px;
  }

  .progress-text {
    font-size: 0.9rem;
    color: #6b7280;
  }

  .scenario-card {
    background: #ffffff;
    border-radius: 28px;
    padding: 2rem;
    border: 1px solid #e5e7eb;
    box-shadow: 0 25px 60px rgba(15, 23, 42, 0.12);
  }

  .scenario-header {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .scenario-tag {
    text-transform: uppercase;
    letter-spacing: 0.12em;
    font-size: 0.75rem;
    color: #2563eb;
  }

  .scenario-body {
    font-size: 1.1rem;
    line-height: 1.6;
    color: #111827;
  }

  .clue-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin: 1.5rem 0;
    color: #888b90;
  }

  .clue-chip {
    padding: 0.5rem 1rem;
    border-radius: 999px;
    background: #eff6ff;
    border: 1px solid #bfdbfe;
    font-size: 0.95rem;
  }

  .decision-row {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-top: 1.5rem;
  }

  .feedback {
    margin-top: 1.8rem;
    padding: 1.2rem;
    border-radius: 18px;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
  }

  .feedback-banner {
    font-size: 1.1rem;
    font-weight: 700;
    margin-bottom: 0.4rem;
  }

  .feedback-banner.success {
    color: #16a34a;
  }

  .feedback-banner.warning {
    color: #ea580c;
  }

  .feedback-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
    flex-wrap: wrap;
  }

  .tip-card {
    margin-top: 2rem;
    padding: 1.5rem 2rem;
    border-radius: 22px;
    background: #ffffff;
    border: 1px solid #e5e7eb;
    box-shadow: 0 10px 20px rgba(15, 23, 42, 0.08);
  }

  .game-finish {
    max-width: 900px;
    margin: 0 auto;
    padding: 0 1.5rem 3rem;
    text-align: center;
  }

  .game-finish h2 {
    font-size: clamp(2rem, 3vw, 2.6rem);
    margin-bottom: 1rem;
  }

  .badge-row {
    display: grid;
    gap: 1rem;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    margin: 2rem 0;
  }

  .badge {
    padding: 1.2rem;
    border-radius: 18px;
    background: #ffffff;
    border: 1px solid #e5e7eb;
    box-shadow: 0 10px 20px rgba(15, 23, 42, 0.08);
  }

  .badge-title {
    display: block;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    font-size: 0.8rem;
    color: #2563eb;
  }

  .badge-value {
    display: block;
    font-size: 1.6rem;
    font-weight: 700;
    margin-top: 0.5rem;
  }

  @keyframes sweep {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  @media (max-width: 640px) {
    .scenario-card {
      padding: 1.5rem;
    }

    .mission-panel {
      padding: 2rem 1.5rem;
    }
  }
</style>
